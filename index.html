<html>

  <head>
  <meta name="twitter:card" content="photo">
  <meta name="twitter:site" content="@cabbibo">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:url" content="http://cabbi.bo">
  <meta name="twitter:title" content="Long Live Synesthesia">
  <meta name="twitter:description" content="Long Live Synesthesia">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:image" content="http://cabbi.bo/image.png">
  <meta name="twitter:image:width" content="1440">
  <meta name="twitter:image:height" content="900">
  <meta name="twitter:domain" content="cabbi.bo">
  <meta itemprop="name" content="Cabbi.bo">
  <meta itemprop="description" content="Long Live Synesthesia">
  <meta itemprop="image" src="http://cabbi.bo/image.png">
  <meta property="og:title" content="Cabbi.bo">
  <meta property="og:type" content="website">
  <meta property="og:image" content="http://cabbi.bo/image.png"/>
  <meta property="og:site_name" content="Cabbi.bo">
  <meta property="og:description" content="Long Live Synesthesia">
  <style>
     @font-face {
      font-family: "GeoSans";
      src: url("lib/GeosansLight.ttf");
    }
    
    body{
      left:0px;
      top:0px;
      margin:0px;
      background:#000;
      color:#fff;
      font-family:"GeoSans";
    }

    
    #loading{

      position: fixed;
      top: 50%;
      left: 50%;
      width:100%;
      height: 50px;
      text-align: center;
      margin-top: -25px;
      margin-left:-50%;
      font-size: 40px;
    
    }

    #songLoad{

      font-size: 25px;

    }

    #songLoad a{

      opacity:.6;
      text-decoration:underline;

    }

    #songLoad a:hover{

      opacity:1;

    }

    #dedication{

      font-size: 40px;

    }
  </style>

  </head>
  <body>


<div id = "loading">
  <div id="dedication"></div>
  <div id="songLoad"></div>
</div>

<script src = "lib/three.js"                  ></script>
<script src = "lib/jquery.min.js"             ></script>
<script src = "lib/Tween.js"                  ></script>
<script src = "lib/TrackballControls.js"      ></script>
<script src = "lib/MouseMoveControls.js"      ></script>
<script src = "lib/ShaderLoader.js"           ></script>
<script src = "lib/underscore.js"             ></script>
<script src = "lib/dat.gui.min.js"            ></script>
<script src = "lib/GUI.js"                    ></script>

<script src = "lib/AudioController.js"        ></script>
<script src = "lib/AudioTexture.js"           ></script>
<script src = "lib/LoadedAudio.js"            ></script>
<script src = "lib/UserAudio.js"              ></script>

<script src = "lib/TextCreator.js"            ></script>
<script src = "lib/DiffusionRenderer.js"      ></script>

<script src = "SnowflakeGeometry.js"          ></script>
<script src = "Snowflake.js"                  ></script>
<script src = "HexGrid.js"                    ></script>
<script src = "Choreography.js"               ></script>

<script src = "initLoadSnowflake.js"          ></script>
<script src = "initSnowflakes.js"             ></script>
<script src = "initChoreography.js"           ></script>
<script src = "initText.js"                   ></script>

<script>


    var scene, camera, renderer , clock;
    var geometry, material, mesh;
    var controls;
  
    var debugLines , debugPoints , debugMesh;

    var loaded = false;
    var loadSnowflake;

    var textCreator;

    var dedication = "For You";

    var quoteText = [

      "Out beyond ideas of wrongdoing and rightdoing,",
      "there is a field. I'll meet you there.",
      "","",
      "When the soul lies down in that grass,",
      "the world is too full to talk about.",
      "","",
      "                       - Rumi"


    ].join("\n");


    // 3D Text Chunks
    var title , quote;


    /*

    TODO: Get dedication / quote information

    */

    // Gets a snowflake in so we can keep
    // people entertained while everything loads
    setup();
    animate();



    var updateSim = true;

    // Creates the geometry used, the texture to reset, 
    // by using the simulation size
    var SIM_SIZE      = 512;
    var SNOWFLAKE_GEO = createHexGridGeometry( SIM_SIZE-1 );
    var RESET_TEXTURE = createResetTexture( SIM_SIZE );

    var choreography; 

    var snowflakes = [];


    var shaders = new ShaderLoader('shaders');

    var gui = new dat.GUI();

    shaders.load( 'vs-snow'       , 'snow'        , 'vertex'   );
    shaders.load( 'fs-snow'       , 'snow'        , 'fragment' );
    
    shaders.load( 'vs-test1'      , 'test1'       , 'vertex'   );
    shaders.load( 'fs-test1'      , 'test1'       , 'fragment' );
    shaders.load( 'vs-debugMesh'  , 'debugMesh'   , 'vertex'   );
    shaders.load( 'fs-debugMesh'  , 'debugMesh'   , 'fragment' );


    shaders.load( 'ss-test1'      , 'test1'       , 'simulation' );
    shaders.load( 'ss-snowflake1' , 'snowflake1'  , 'simulation' );


    // Audio should always load after shaders,
    // so lets leave it
    shaders.shaderSetLoaded = function(){
    //  onShadersLoaded();
    }

   
    var audioController = new AudioController();

    //audioController.mute.gain.value = 0;

    var audio = new LoadedAudio( audioController , 'audio/beyond.mp3' , {
      texture: false
    });


    /*

      All of this happens before the project even starts /
      inits, AKA, keeps people interested while we load things

    */
    var elem = document.getElementById("dedication");
    elem.innerHTML = dedication;

    audio.loadProgress = function(){

      var elem = document.getElementById("songLoad");


      // Tells people how much of the song is loaded
      // and shows them, by filling out the snowflake
      var p = Math.floor( this.loaded * 100);
      p += "%";
      elem.innerHTML = "Loading Song: " + p;

      loadSnowflake.material.uniforms.filled.value = this.loaded * 10.;

    }


    // Adds in first start text
    audio.onLoad = function(){

      var elem = document.getElementById("songLoad");
      elem.innerHTML = "<a onclick='start()'>Let It Snow</a>"
      onLoad();

    }



   // var userAudio = new UserAudio( audioController ); 

    var matcap  = THREE.ImageUtils.loadTexture( 'img/rough-aluminium.jpg' );
    var aT      = audioController.texture;

    // Our Uniforms!
    // To be used in both simulation, and renderering
    var uniforms = {

      t_matcap:     { type:"t" , value: matcap    },
      t_audio:      { type:"t" , value: aT        },
      t_depth:      { type:"t" , value: null      },
      filled:       { type:"f" , value: 0         },
      time:         { type:"f" , value: 0         },
      dT:           { type:"f" , value: 0         },
      debug:        { type:"f" , value: 0         },

    }

    


    // Before all our shaders / song are loaded
    function setup(){

      renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
     
      window.addEventListener( 'resize', onWindowResize , false );
      window.addEventListener( 'keydown', onKeyDown , false );

      document.body.appendChild( renderer.domElement );
     
      scene   = new THREE.Scene();

      var ar  = window.innerWidth / window.innerHeight;
      camera  = new THREE.PerspectiveCamera( 75, ar , .003, 30 );

      camera.position.z = 1;
      controls = new THREE.TrackballControls( camera , renderer.domElement );

      loadSnowflake = initLoadSnowflake();
      loadSnowflake.scale.multiplyScalar( .004 );
      scene.add( loadSnowflake );

    }

    function init(){

      textCreator = new TextCreator( 30 );


      //text
      clock = new THREE.Clock();

      initText( quoteText );
      initSnowflakes();
      initChoreography();



      /* var snowflake = new Snowflake( ss , vs , fs );
      snowflakes.push( snowflake );

      snowflake.activate();*/

    }

   
    function animate() {
      
      requestAnimationFrame( animate );

      //controls.update();
      TWEEN.update();
        
      if( loaded == true ){

        audioController.update();

        uniforms.dT.value = clock.getDelta();
        uniforms.time.value += uniforms.dT.value;

        choreography.update();

        if( updateSim == true ){

          for( var i = 0; i < snowflakes.length; i++ ){

            snowflakes[i].update();

          }

        }

      }


      renderer.render( scene, camera );
      

    }

      // Resets the renderer to be the proper size
    function onWindowResize(){

      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();


      renderer.setSize( window.innerWidth, window.innerHeight );
     
      var dpr = devicePixelRatio || 1;

    }

    function onKeyDown(e){

      if( e.keyCode == 32 ){

        updateSim = !updateSim;

      }

      if( e.keyCode == 48 ){

        uniforms.debug.value = (uniforms.debug.value + 1) % 4;

      }


      /*if( e.keyCode == 49 ){

        debugLines.visible = !debugLines.visible;

      }

      if( e.keyCode == 50 ){

        debugPoints.visible = !debugPoints.visible;

      }
      
      if( e.keyCode == 51 ){

        debugMesh.visible = !debugMesh.visible;

      }*/


     console.log( e.keyCode );


   }


   function start(){

     init();

     $("#loading").fadeOut( 1000 , function(){});


    var i = { v: loadSnowflake.material.uniforms.filled.value };
    var f = { v: 0 }

    var t = new TWEEN.Tween( i ).to( f , i.v * 300);

    t.onUpdate( function(){
    //  console.log('hello');
      loadSnowflake.material.uniforms.filled.value = i.v;
    });

    t.onComplete( function(){
      scene.remove( loadSnowflake );

      window.setTimeout( function(){

        audio.play();
        loaded = true;

      }, 1000 );

    });

    t.start();


   }

   function createResetTexture( size ){

     var data = new Float32Array( size * size * 4 );

      for( var i = 0; i < data.length; i+=4 ){


        data[ i + 0 ] = 0;
        data[ i + 1 ] = 100;
        data[ i + 2 ] = 0;
        data[ i + 3 ] = 100;

      }

      var texture = new THREE.DataTexture( 
        data,
        size,
        size,
        THREE.RGBAFormat,
        THREE.FloatType
      );

      texture.minFilter =  THREE.NearestFilter,
      texture.magFilter = THREE.NearestFilter,

      texture.needsUpdate = true;

      return texture;

   }

   //loaded = ++
   function onLoad(){


   }

 </script>

</body>
</html>
