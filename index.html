<html>

  <head>
  <meta name="twitter:card" content="photo">
  <meta name="twitter:site" content="@cabbibo">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:url" content="http://cabbi.bo">
  <meta name="twitter:title" content="Long Live Synesthesia">
  <meta name="twitter:description" content="Long Live Synesthesia">
  <meta name="twitter:creator" content="@cabbibo">
  <meta name="twitter:image" content="http://cabbi.bo/image.png">
  <meta name="twitter:image:width" content="1440">
  <meta name="twitter:image:height" content="900">
  <meta name="twitter:domain" content="cabbi.bo">
  <meta itemprop="name" content="Cabbi.bo">
  <meta itemprop="description" content="Long Live Synesthesia">
  <meta itemprop="image" src="http://cabbi.bo/image.png">
  <meta property="og:title" content="Cabbi.bo">
  <meta property="og:type" content="website">
  <meta property="og:image" content="http://cabbi.bo/image.png"/>
  <meta property="og:site_name" content="Cabbi.bo">
  <meta property="og:description" content="Long Live Synesthesia">
  <style>
     @font-face {
      font-family: "GeoSans";
      src: url("lib/GeosansLight.ttf");
    }
    
    body{
      left:0px;
      top:0px;
      margin:0px;
      background:#000;
      color:#fff;
      font-family:"GeoSans";
      overflow: hidden ;
    }

      #pano{ position: absolute; left: 0; top: 0;right: 0;bottom: 0; width: 100%; height: 100%; }
      #pano canvas{ position: absolute; left: 0; top: 0;right: 0;bottom: 0; width: 100%; height: 100%; }
      #fade{ position: absolute; left: 0; top: 0;right: 0;bottom: 0; background-color: black; opacity: 0; pointer-events: none;}
      #time{
        color: red;
        z-index: 100;
        position: absolute;
        left: 0;
        top: 0;
      }
    
    #loading{

      position: fixed;
      top: 50%;
      left: 50%;
      width:100%;
      height: 50px;
      text-align: center;
      margin-top: -25px;
      margin-left:-50%;
      font-size: 40px;
    
    }

    #songLoad{

      font-size: 25px;

    }

    #songLoad a{

      opacity:.6;
      text-decoration:underline;

    }

    #songLoad a:hover{

      opacity:1;

    }

    #dedication{

      font-size: 40px;

    }

    #sharePanel{ position: absolute; left: 50%; top: 50%; width: 800px; height: 400px; background-color: rgba( 0,0,0, .8 ); margin-left: -400px; margin-top: -200px; padding: 20px; display: none;}
    #sharePanel h1{ font-size: 22px;} 
  </style>

  </head>
  <body>


  <div id="pano" ></div>
  <div id="fade"></div>
  <div id="time"></div>

  <div id="loading">
    <div id="dedication"></div>
    <div id="songLoad"></div>
  </div>

  <div id="sharePanel" >
    <h1>Who are you sending this message to?</h1>
    <input type="text" id="shareTo" ></input>
    <h1>What's the message?</h1>
    <textarea id="shareMessage"></textarea>
    <h1>You can sign, if you want</h1>
    <input type="text" id="shareFrom" ></input>
    <p>That'is it. This is your link:</p>
    <input type="text" id="shareLink"></input>
    <p>You can share it on your favorite social network:</p>
    <ul>
      <li class="twitter"></li>
      <li class="facebook"></li>
      <li class="googleplus"></li>
    </ul>
  </div>

<script src = "lib/three.js"                  ></script>
<script src = "lib/jquery.min.js"             ></script>
<script src = "lib/Tween.js"                  ></script>
<script src = "lib/TrackballControls.js"      ></script>
<script src = "lib/MouseMoveControls.js"      ></script>
<script src = "lib/CabShaderLoader.js"           ></script>
<script src = "lib/underscore.js"             ></script>
<script src = "lib/dat.gui.min.js"            ></script>
<script src = "lib/GUI.js"                    ></script>

<script src = "lib/AudioController.js"        ></script>
<script src = "lib/AudioTexture.js"           ></script>
<script src = "lib/LoadedAudio.js"            ></script>
<script src = "lib/UserAudio.js"              ></script>

<script src = "lib/TextCreator.js"            ></script>
<script src = "lib/DiffusionRenderer.js"      ></script>
<script src = "lib/NormalMapper.js"           ></script>

<script src = "SnowflakeGeometry.js"          ></script>
<script src = "Snowflake.js"                  ></script>
<script src = "HexGrid.js"                    ></script>
<script src = "Choreography.js"               ></script>
<script src = "Aurora.js"                     ></script>

<script src = "initLoadSnowflake.js"          ></script>
<script src = "initSnowflakes.js"             ></script>
<script src = "initChoreography.js"           ></script>
<script src = "initText.js"                   ></script>


<script src="Wagner/Wagner.js"></script>
<script src="Wagner/Wagner.base.js"></script>
<script src="Wagner/ShaderLoader.js"></script>

<script src="timeline.js"></script>
<script src="storyboard.js"></script>
<script src="scripts.js"></script>


<script>


    var scene, camera, renderer , clock;
    var geometry, material, mesh;
    var controls;

    // uses space to switch from sweeping to non sweeping
    var canSweep = false;
    var debugLines , debugPoints , debugMesh;
    var choreography , sections; 

    var loaded = false;
    var loadSnowflake;

    var textCreator;

    WAGNER.vertexShadersPath = 'Wagner/vertex-shaders';
    WAGNER.fragmentShadersPath = 'Wagner/fragment-shaders';
    WAGNER.assetsPath = 'Wagner/assets/';

   // var container, renderer, camera, scene, controls, fov = 70;
   var rendering = false;
   var playing = false;
    var composer;
    var vignettePass, FXAAPass, bloomPass, noisePass, lensPass, chromaticAbberationPass;


    var startTime;
var timeLabel = document.getElementById( 'time' );


    TWEEN.origTween = TWEEN.Tween;
    TWEEN.Tween = function (options){
      var res = new TWEEN.origTween(options);
      res.easing(TWEEN.Easing.Quadratic.InOut);
      return res;
    };


  
    // Lets us skip to different sections of audio
    // for timing purposes
    var startingSection = 0;
    

    // 3D Text Chunks
    var title , quote;

    var dedication = "For All Mankind";

    var quoteText = [

      "Out beyond ideas of wrongdoing and rightdoing,",
      "there is a field. I'll meet you there.",
      "",
      "When the soul lies down in that grass,",
      "the world is too full to talk about.",
      "",
      "                       - Rumi"


    ];



    /*

    TODO: Get dedication / quote information

    */

    // Gets a snowflake in so we can keep
    // people entertained while everything loads
    setup();
    animate();



    var updateSim = true;

    // Creates the geometry used, the texture to reset, 
    // by using the simulation size
    var SIM_SIZE      = 512;
    var SNOWFLAKE_GEO = createHexGridGeometry( SIM_SIZE-1 );
    var RESET_TEXTURE = createResetTexture( SIM_SIZE );

    var snowflakes = [];

    var shaders = new CabShaderLoader('shaders');

   // var gui = new dat.GUI();

    shaders.load( 'vs-snow'       , 'snow'        , 'vertex'   );
    shaders.load( 'fs-snow'       , 'snow'        , 'fragment' );
    
    shaders.load( 'vs-aurora'       , 'aurora'        , 'vertex'   );
    shaders.load( 'fs-aurora'       , 'aurora'        , 'fragment' );
    
    shaders.load( 'vs-test1'      , 'test1'       , 'vertex'   );
    shaders.load( 'fs-test1'      , 'test1'       , 'fragment' );
    
    shaders.load( 'vs-debugMesh'  , 'debugMesh'   , 'vertex'   );
    shaders.load( 'fs-debugMesh'  , 'debugMesh'   , 'fragment' );

    shaders.load( 'vs-raytrace'  , 'raytrace'   , 'vertex'   );
    shaders.load( 'fs-raytrace'  , 'raytrace'   , 'fragment' );

    shaders.load( 'vs-spiteSnow'  , 'spiteSnow'   , 'vertex'   );
    shaders.load( 'fs-spiteSnow'  , 'spiteSnow'   , 'fragment' );

    shaders.load( 'vs-cabSnow'  , 'cabSnow'   , 'vertex'   );
    shaders.load( 'fs-cabSnow'  , 'cabSnow'   , 'fragment' );


    shaders.load( 'ss-test1'      , 'test1'       , 'simulation' );
    shaders.load( 'ss-snowflake1' , 'snowflake1'  , 'simulation' );
    shaders.load( 'ss-snowHex1' , 'snowHex1'  , 'simulation' );
    shaders.load( 'ss-snowHex2' , 'snowHex2'  , 'simulation' );
    shaders.load( 'ss-snowHex3' , 'snowHex3'  , 'simulation' );
    shaders.load( 'ss-snowHex4' , 'snowHex4'  , 'simulation' );
    shaders.load( 'ss-snowHex5' , 'snowHex5'  , 'simulation' );
    shaders.load( 'ss-snowHex6' , 'snowHex6'  , 'simulation' );

    shaders.load( 'ss-snowSimplex6' , 'snowSimplex6'  , 'simulation' );
    shaders.load( 'ss-snowSimplex7' , 'snowSimplex7'  , 'simulation' );
    shaders.load( 'ss-snowSimplex8' , 'snowSimplex8'  , 'simulation' );

    shaders.load( 'fs-depthToNormal'  , 'depthToNormal'   , 'fragment' );
    shaders.load( 'fs-hexCorrection'  , 'hexCorrection'   , 'fragment' );

    // Audio should always load after shaders,
    // so lets leave it
    shaders.shaderSetLoaded = function(){
      //  onShadersLoaded();
      console.log('SHRDERS LOADES');
    }

   
    var audioController = new AudioController();

    //audioController.mute.gain.value = 0;

    var audio = new LoadedAudio( audioController , 'audio/beyond.mp3' , {
      texture: false
    });


    /*

      All of this happens before the project even starts /
      inits, AKA, keeps people interested while we load things

    */
    var elem = document.getElementById("dedication");
    elem.innerHTML = dedication;

    audio.loadProgress = function(){

      var elem = document.getElementById("songLoad");


      console.log('PROGS');
      // Tells people how much of the song is loaded
      // and shows them, by filling out the snowflake
      var p = Math.floor( this.loaded * 100);
      p += "%";
      elem.innerHTML = "Loading Song: " + p;

      loadSnowflake.material.uniforms.filled.value = this.loaded * 10.;

    }


    // Adds in first start text
    audio.onLoad = function(){

      console.log('HELLO')
      var elem = document.getElementById("songLoad");
      elem.innerHTML = "<a onclick='start(.1)'>Let It Snow</a>"
      onLoad();

    }

    audio.duration  = 107


   // var userAudio = new UserAudio( audioController ); 

    var matcap        = THREE.ImageUtils.loadTexture( 'img/matcap-red.jpg'  );
    var panoTexture   = THREE.ImageUtils.loadTexture( 'img/pano-blur-red.jpg'    );
    var detailNormal  = THREE.ImageUtils.loadTexture( 'img/scratch.png' );

    detailNormal.wrapS = detailNormal.wrapT  = 	THREE.RepeatWrapping;
    
    var aT = audioController.texture;

    // Our Uniforms!
    // To be used in both simulation, and renderering
    var uniforms = {

      t_matcap:       { type:"t" , value: matcap        },
      t_audio:        { type:"t" , value: aT            },
      t_pano:         { type:"t" , value: panoTexture   },
      t_detailNormal: { type:"t" , value: detailNormal  },
      
      t_depth:        { type:"t" , value: null          },
      t_normal:       { type:"t" , value: null          },
      
      filled:         { type:"f" , value: 0             },
      time:           { type:"f" , value: 0             },
      dT:             { type:"f" , value: 0             },
      debug:          { type:"f" , value: 0             },

    }

    


    // Before all our shaders / song are loaded
    function setup(){

      console.log( 'SETTING UP' );
      container = document.getElementById( 'pano' );

      renderer = new THREE.WebGLRenderer( { antialiasing: false });
	  renderer.setClearColor( 0, 1 );
      renderer.setSize( window.innerWidth, window.innerHeight );
     
      window.addEventListener( 'resize', onWindowResize , false );
      window.addEventListener( 'keydown', onKeyDown , false );

      //document.body.appendChild( renderer.domElement );
      container.appendChild( renderer.domElement );
     
      scene   = new THREE.Scene();

      var ar  = window.innerWidth / window.innerHeight;
      camera  = new THREE.PerspectiveCamera( 70, ar , .1, 3000 );

      camera.target = new THREE.Vector3( 0, 0, 0 );
      //camera.position.set( 50, 50, 50 );
      
	//camera.target = new THREE.Vector3( 0, 0, 0 );
	//camera.position.set( 50, 50, 50 );

      camera.position.z = 1;
      controls = new THREE.TrackballControls( camera , renderer.domElement );

      loadSnowflake = initLoadSnowflake();
      loadSnowflake.scale.multiplyScalar( .004 );
      scene.add( loadSnowflake );

      composer = new WAGNER.Composer( renderer, { useRGBA: true } );
	
      bloomPass = new WAGNER.MultiPassBloomPass();
      bloomPass.params.blurAmount = 20;
      FXAAPass = new WAGNER.FXAAPass();
      vignettePass = new WAGNER.Vignette2Pass();
      vignettePass.params.boost = 2;
      vignettePass.params.reduction = 3;
      noisePass = new WAGNER.NoisePass();
      noisePass.params.amount = .05;
      chromaticAbberationPass = new WAGNER.ChromaticAberrationPass();
      


      onWindowResize();

      rendering = true;
    }

    function init(){

      console.log( 'INITING');
      textCreator = new TextCreator( 30 );


      //text
      clock = new THREE.Clock();

      initText( quoteText );
      //initSnowflakes();
      //initChoreography();
      initScene();


      aurora = createAurora();
      scene.add( aurora );

      aurora.position.x = -3.;
      aurora.rotation.y = .3;
      aurora.rotation.x = .1;
      aurora.rotation.z = -Math.PI / 2;
      /* var snowflake = new Snowflake( ss , vs , fs );
      snowflakes.push( snowflake );

      snowflake.activate();*/

    }

   
    function animate() {
      
      requestAnimationFrame( animate );

     // controls.update();
      TWEEN.update();
        
      if( loaded == true ){

        audioController.update();

        uniforms.dT.value = clock.getDelta();
        uniforms.time.value += uniforms.dT.value;

       // choreography.update();

        if( updateSim == true ){

          for( var i = 0; i < snowflakes.length; i++ ){

            snowflakes[i].update();

          }

        }

      }


    if( playing && !canSweep ) {
      var t = t = uniforms.time.value;//audio.currentTime;
      timeLabel.textContent = t;
      updateStory( t );
      updateScene( t );
    }
	/*camera.position.copy( sampleAtTime( t ) );
	camera.lookAt( camera.target );*/
	camera.lookAt( camera.target );
	//renderer.render( scene, camera );

    //console.log('HESSS');
	composer.reset();
		
	composer.render( scene, camera );
	composer.pass( chromaticAbberationPass );
	composer.pass( bloomPass );
	composer.pass( vignettePass );
	composer.pass( FXAAPass );
	composer.pass( noisePass );
	
	composer.toScreen();
   // renderer.render( scene, camera );
      

    }

      // Resets the renderer to be the proper size
    function onWindowResize(){

      var s = 1;//window.location.hash.substr( 1 ) || 1;
	var w = s * container.clientWidth, 
		h = s * container.clientHeight;
      renderer.setSize( w, h );
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      composer.setSize( renderer.domElement.width, renderer.domElement.height );
      renderer.domElement.style.width = window.innerWidth + 'px';
      renderer.domElement.style.height = window.innerHeight + 'px';


      /*camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();


      renderer.setSize( window.innerWidth, window.innerHeight );
     
      var dpr = devicePixelRatio || 1;*/

    }

    function onKeyDown(e){

      return;

      if( e.keyCode == 32 ){

        canSweep = !canSweep; //true;
       // updateSim = !updateSim;

      }

      if( e.keyCode == 48 ){

        uniforms.debug.value = (uniforms.debug.value + 1) % 4;

      }


      /*if( e.keyCode == 49 ){

        debugLines.visible = !debugLines.visible;

      }

      if( e.keyCode == 50 ){

        debugPoints.visible = !debugPoints.visible;

      }
      
      if( e.keyCode == 51 ){

        debugMesh.visible = !debugMesh.visible;

      }*/


     console.log( e.keyCode );


   }


   function start( speed ){

     var speed = speed || .1;
     init();

     $("#loading").fadeOut( speed * 1000 , function(){});


    var i = { v: loadSnowflake.material.uniforms.filled.value };
    var f = { v: 0 }

    var s = loadSnowflake.material.uniforms.filled.value
    var t = new TWEEN.Tween( i ).to( f , s * speed * 300);

    t.onUpdate( function(){
    //  console.log('hello');
      loadSnowflake.material.uniforms.filled.value = i.v;
    });

    t.onComplete( function(){
      scene.remove( loadSnowflake );

      window.setTimeout( function(){

   
        var t = 0;
        console.log( t );
        console.log( 'HELL');
        uniforms.time.value += t;

        //var t = 0;
        
        audio.play( t );
        loaded = true;

        playing = true;
        startTime = Date.now();



      }, 1000 * speed );

    });

    t.start();


   }

   function createResetTexture( size ){

     var data = new Float32Array( size * size * 4 );

      for( var i = 0; i < data.length; i+=4 ){


        data[ i + 0 ] = 0;
        data[ i + 1 ] = 100;
        data[ i + 2 ] = 0;
        data[ i + 3 ] = 100;

      }

      var texture = new THREE.DataTexture( 
        data,
        size,
        size,
        THREE.RGBAFormat,
        THREE.FloatType
      );

      texture.minFilter =  THREE.NearestFilter,
      texture.magFilter = THREE.NearestFilter,

      texture.needsUpdate = true;

      return texture;

   }

   //loaded = ++
   function onLoad(){


   }

   var sharePanel = document.getElementById( 'sharePanel' );
   initSharePanel();

   function initSharePanel() {

    var shareTo = document.getElementById( 'shareTo' ),
      shareMessage = document.getElementById( 'shareMessage' ),
      shareFrom = document.getElementById( 'shareFrom' ),
      shareLink = document.getElementById( 'shareLink' );

    function updateShare() {

      var to = shareTo.value,
        msg = shareMessage.value,
        from = shareFrom.value;

      var str = [
        [ 'to', to ],
        [ 'msg', msg ],
        [ 'from', from ] 
      ].map( function( a, b ) { 
        return a.join( '=' );
      } ).join( '&' );

      var link = window.location.protocol + '//' + window.location.host + '#' + btoa( encodeURIComponent( escape( str ) ) );
      shareLink.value = link;

    }

    shareTo.addEventListener( 'change', updateShare );
    shareMessage.addEventListener( 'change', updateShare );
    shareFrom.addEventListener( 'change', updateShare );
      

   }

   function showSharePanel() {
   }

   function extractShareData() {

      var queryString = unescape( decodeURIComponent( atob( window.location.hash.substr( 1 ) ) ) );
      var fields = queryString.split( '&' ).map( function( a ) { return a.split( '=' ); } );
     
      console.log( fields );

      if( fields.length === 3 ) {

        function extractField( id ) { return function( a ){ if( a[ 0 ] === id ){ return a[ 1 ] } } }
        function clean( a ) { return a != undefined }

        console.log( 'To:' + ( fields.map( extractField( 'to' ) ).filter( clean ) ) );
        console.log( 'From:' + ( fields.map( extractField( 'from' ) ).filter( clean ) ) );
        console.log( 'Message:' + ( fields.map( extractField( 'msg' ) ).filter( clean ) ) );

      } else {

        console.log( 'No Share Data' );

      }

   }

   function processMessage( msg ) {

    var sentences = msg.split( /\r?\n|\r/ );
    var words = sentences.map( function( s ) {
      return s.split( /( )/ );
    } );
    console.log( words );

   }

   console.clear();
   processMessage( 'word' );
   processMessage( 'very long sentence without any line break because we want to test if this algorithm can break up the sentences in chunks that can be rendered on canvas' );
    processMessage( 'this is not a poem\rit\'s a silly convenient\rjapanese thingie');
    // dG8lMjUzRGhlbGxvJTI1MjZtc2clMjUzRHRoaXMlMjUyMGlzJTI1MjBhJTI1MjB0ZXN0JTI1MEF3aXRoJTI1MjBtdWx0aXBsZSUyNTIwbGluZXMlMjUwQWFuZCUyNTIwdmVyeSUyNTIwdmVyeSUyNTIwd2luZGluZyUyNTIwYW5kJTI1MjBsb25nJTI1MjBsaW5lcyUyNTIwdG8lMjUyMHRlc3QlMjUyMHRoZSUyNTIwYWxnb3JpdGhtJTI1MjZmcm9tJTI1M0RNZQ

   extractShareData();

   var ellapsedTime;
var isEnded = false;

window.addEventListener( 'mousemove', function( e ) {
	console.log( 'mousemove' );
    if( !audio || !canSweep ) return;

    console.log( audio );
	var t = audio.duration * ( e.pageX / window.innerWidth );
	updateStory( t );
	updateScene( t );
	timeLabel.textContent = t;
} );
   
   function end(){

     $("#loading").fadeIn( 1000 , function(){});

    var elem = document.getElementById("loading");
    elem.innerHTML =  "<a class='finalLink' onclick='createShareLink()'>Send Your Own Card</a>";

   }

   function createShareLink(){

     console.log('TODO!');

   }
 </script>

</body>
</html>
