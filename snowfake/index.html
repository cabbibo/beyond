<body></body>
<script src="ImprovedNoise.js" ></script>
<script>
var noise = new ImprovedNoise();

var canvas = document.createElement( 'canvas' ),
	ctx = canvas.getContext( '2d' );
canvas.width = 2048;
canvas.height = 2048;
canvas.style.border = '1px solid #666'
document.body.appendChild( canvas );
canvas.style.backgroundColor = 'black';

function drawPlate( x, y, s ) {

	var y = Math.sqrt( 3 ) / 2;

	for( var j = 1; j < s; j++ ) {
		ctx.save();
		ctx.translate( x, 0 );
		ctx.scale( s - j, s - j );
		ctx.beginPath();
		ctx.moveTo( 1, 0 );
		ctx.lineTo( .5, y );
		ctx.lineTo( -.5, y );
		ctx.lineTo( -1, 0 );
		ctx.lineTo( -.5, -y );
		ctx.lineTo( .5, -y );
		var c = Math.floor( Math.random() * 255 );
		//ctx.fillStyle = 'rgb('+c+','+c+','+c+')';
		ctx.fill();
		ctx.restore();
		j += 1 + Math.random() * 10;
	}

}

function drawNeedle( x, y, l, s ) {

	ctx.save();
	ctx.translate( x, y );
	ctx.scale( s, s );
	ctx.lineWidth = s;
	ctx.beginPath();
	ctx.moveTo( 0, 0 );
	ctx.lineTo( l, l );
	ctx.stroke();
	ctx.beginPath();
	ctx.moveTo( 0, 0 );
	ctx.lineTo( l, -l );
	ctx.stroke();
	ctx.restore();

}

function repeat( f ) {

	for( var j = 0; j < 6; j++ ) {
		ctx.save();
		ctx.rotate( 2 * Math.PI * j / 6 );
		f();
		ctx.restore();
	}
}

function draw() {

	var seed = Math.random() * Date.now();

	ctx.globalAlpha = 1;
	ctx.fillStyle = '#000000';
	ctx.fillRect( 0, 0, canvas.width, canvas.height );
	ctx.save();
	ctx.translate( .5 * canvas.width, .5 * canvas.height );

	ctx.fillStyle = '#ffffff';
	ctx.strokeStyle = '#ffffff';
	ctx.globalAlpha = .1;

	var length = ( .1 + Math.random() * .45 ) * canvas.width;

	for( var x = 0; x < length; x++ ) {

		var r = x / length;

		var v = Math.abs( noise.noise( x * 2.75 + seed, 1.34, .12 ) );
		var w = Math.max( 1, ( 2 - r ) * .25 * length * v );
		repeat( function() { drawPlate( x, 0, w ) } );

		var v2 = .5 + Math.abs( noise.noise( x * 2.275 + seed, 5.134, 2.12 ) );
		var l = Math.min( Math.max( 0, w + r * .5 * length * v2 ), 40 );
		var w2 = Math.max( 1, 3 * v2 );
		repeat( function() { drawNeedle( x, 0, l, w2 ) } );
	
		x += .5 * w;

	}

	ctx.restore();

	heightToNormal( canvas );

}

draw();

canvas.addEventListener( 'click', draw );

function normalize( x, y, z ) {

	var l = Math.sqrt( x * x + y * y + z * z );
	return {
		x: x / l,
		y: y / l,
		z: z / l
	}
}

function cross( a, b ) {

	return { 
		x: a.y * b.z - a.z * b.y, 
		y: a.z * b.x - a.x * b.z,
		z: a.x * b.y - a.y * b.x
	};

}

function heightToNormal( c ) {

	var oC = document.getElementById( 'normal' );
	if( oC ) document.body.removeChild( oC );

	var canvas = document.createElement( 'canvas' );
	canvas.id = 'normal';
	canvas.width = c.width;
	canvas.height = c.height;
	var nCtx = canvas.getContext( '2d' );
	nCtx.drawImage( c, 0, 0 );

	var iSrcData = ctx.getImageData( 0, 0, canvas.width, canvas.height );
	var iData = ctx.getImageData( 0, 0, canvas.width, canvas.height );
	var d = iData.data;
	var srcD = iSrcData.data;

	var p = 0;
	for( var y = 1; y < canvas.height - 1; y++ ) {
		for( var x = 1; x < canvas.width - 1; x++ ) {
			p = y * canvas.width * 4 + x * 4;

			var h01 = srcD[ p - 4 ];
			var h21 = srcD[ p - canvas.width * 4 ];
			var h10 = srcD[ p + 4 ];
			var h12 = srcD[ p + canvas.width * 4 ];

			var va = normalize( 2, 0, h10 - h01 );
			var vb = normalize( 0, 2, h12 - h21 );
			var n = cross( va, vb );
			n = normalize( n.x, n.y, n.z );
			
			d[ p ] = ( .5 + .5 * n.x ) * 255;
			d[ p + 1 ] = ( .5 + .5 * n.y ) * 255;
			d[ p + 2 ] = ( .5 + .5 * n.z ) * 255;
		}
	}

	nCtx.putImageData( iData, 0, 0 );

	document.body.appendChild( canvas );

}

</script>